<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mpx.minipx.mapper.AiLogMapper">

  <!-- ==========================================================
      AI LOG  (관리자)
      - 세션 목록 + 세션 상세(대화 이벤트)
      ========================================================== -->

  <!-- ==========================================================
      AI 세션 목록 COUNT
      ========================================================== -->
  <select id="getAiSessionListCount" parameterType="map" resultType="int">
    /*getAiSessionListCount*/
    SELECT
          COUNT(1) AS CNT
      FROM tb_ai_session S
      LEFT JOIN tb_user U
        ON U.USER_SEQ = S.USER_SEQ
     WHERE 1 = 1
       <if test="startDate != null and startDate != ''">
       AND S.FST_REG_DTTI <![CDATA[ >= ]]> CONCAT(#{startDate}, ' 00:00:00')
       </if>
       <if test="endDate != null and endDate != ''">
       AND S.FST_REG_DTTI <![CDATA[ <= ]]> CONCAT(#{endDate}, ' 23:59:59')
       </if>

       <if test="searchKeyword != null and searchKeyword != ''">
       AND (
              U.USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
           OR U.USER_NM LIKE CONCAT('%', #{searchKeyword}, '%')
           OR S.TITLE   LIKE CONCAT('%', #{searchKeyword}, '%')
           )
       </if>
  </select>


  <!-- ==========================================================
      AI 세션 목록 조회
      - 화면(테이블): 일시 / 요청자 / 제목
      ========================================================== -->
  <select id="getAiSessionList" parameterType="map" resultType="map">
    /*getAiSessionList*/
    SELECT
          S.SESSION_ID     AS sessionId
        , S.USER_SEQ       AS userSeq
        , U.USER_ID        AS userId
        , U.USER_NM        AS userNm
        , S.TITLE          AS title
        , S.LLM_MODEL      AS llmModel
        , S.PROMPT_VERSION AS promptVersion
        , DATE_FORMAT(S.FST_REG_DTTI, '%Y-%m-%d %H:%i:%s') AS fstRegDtti
        , DATE_FORMAT(S.LST_UPD_DTTI, '%Y-%m-%d %H:%i:%s') AS lstUpdDtti
      FROM tb_ai_session S
      LEFT JOIN tb_user U
        ON U.USER_SEQ = S.USER_SEQ
     WHERE 1 = 1
       <if test="startDate != null and startDate != ''">
       AND S.FST_REG_DTTI <![CDATA[ >= ]]> CONCAT(#{startDate}, ' 00:00:00')
       </if>
       <if test="endDate != null and endDate != ''">
       AND S.FST_REG_DTTI <![CDATA[ <= ]]> CONCAT(#{endDate}, ' 23:59:59')
       </if>

       <if test="searchKeyword != null and searchKeyword != ''">
       AND (
              U.USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
           OR U.USER_NM LIKE CONCAT('%', #{searchKeyword}, '%')
           OR S.TITLE   LIKE CONCAT('%', #{searchKeyword}, '%')
           )
       </if>
     ORDER BY S.LST_UPD_DTTI DESC, S.SESSION_ID DESC
     LIMIT #{pageSize}
    OFFSET #{offset}
  </select>


  <!-- ==========================================================
      AI 세션 상세(대화 이벤트) 조회
      - 버블 화면용: USER_MSG / ASSIST_MSG / TOOL_CALL / TOOL_OUTPUT
      - turn_no, seq_no로 정렬해서 "진짜 대화 순서" 유지
      ========================================================== -->
  <select id="getAiSessionDetail" parameterType="map" resultType="map">
    /*getAiSessionDetail*/
    SELECT
          E.EVENT_ID      AS eventId
        , E.TURN_ID       AS turnId
        , T.TURN_NO       AS turnNo
        , E.SEQ_NO        AS seqNo
        , E.EVENT_TYPE    AS eventType
        , E.ROLE          AS role
        , E.TOOL_NM       AS toolNm
        , E.CALL_ID       AS callId
        , E.CONTENT_TEXT  AS contentText
        , E.CONTENT_JSON  AS contentJson
        , CAST(E.CONTENT_JSON AS CHAR) AS contentJson
        , DATE_FORMAT(E.FST_REG_DTTI, '%Y-%m-%d %H:%i:%s') AS fstRegDtti
      FROM tb_ai_session S
      INNER JOIN tb_ai_turn T
        ON T.SESSION_ID = S.SESSION_ID
      INNER JOIN tb_ai_event E
        ON E.TURN_ID = T.TURN_ID
     WHERE 1 = 1
       AND S.SESSION_ID = #{sessionId}
     ORDER BY T.TURN_NO ASC, E.SEQ_NO ASC, E.EVENT_ID ASC
     <if test="limit != null and limit > 0">
     LIMIT #{limit}
     </if>
  </select>

</mapper>
