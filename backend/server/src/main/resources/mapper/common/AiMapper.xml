<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mpx.minipx.mapper.AiMapper">

	<!-- AI 상품 목록 조회 -->
	<select id="aiGetItemList" parameterType="map" resultType="map">
		SELECT T1.ITEM_SEQ                                                       AS "상품일련번호"
			 , T1.ITEM_NM                                                        AS "상품명"
			 , T1.PRICE                                                          AS "낱개가격"
			 , T1.UNIT                                                           AS "가격"
			 , T1.PRICE * T1.UNIT 												 AS "단위가격"
			 , (SELECT CODE_DETAIL_NM FROM tb_code_detail WHERE CODE_GROUP = 'ITEM_TYPE_CODE' AND CODE_DETAIL = T1.ITEM_TYPE_CODE)	AS "상품분류"
			 , (SELECT CODE_DETAIL_NM FROM tb_code_detail WHERE CODE_GROUP = 'ITEM_DTL_TYPE_CODE' AND CODE_DETAIL = T1.ITEM_DTL_TYPE_CODE) AS "상품상세분류"
			 , T1.SOLD_OUT_YN                                                    AS "품절여부"
			 , ROUND(IFNULL(O.SALE_CNT, 0) / T1.UNIT)							 AS "판매량"
			 , T1.FST_REG_DTTI                                                   AS "등록일"
		  FROM tb_item T1					       								 /*테이블_상품 정보 관리*/
		  LEFT JOIN (
			      SELECT ITEM_SEQ
			           , SUM(CNT) AS SALE_CNT
			        FROM tb_order
			       WHERE ORDER_STATUS_CODE = '11'
			       GROUP BY ITEM_SEQ) O
		    ON T1.ITEM_SEQ = O.ITEM_SEQ			  
		 WHERE T1.USE_YN = 'Y'
		 <if test='itemSeq != null and itemSeq != ""'>
		   AND T1.ITEM_SEQ = #{itemSeq} 
		 </if>		 
		 <if test='itemNm != null and itemNm != ""'>
		   AND T1.ITEM_NM LIKE CONCAT('%', #{itemNm}, '%')
		 </if>		 
		 <if test='itemType != null and itemType != ""'>
		   AND T1.ITEM_TYPE_CODE = (SELECT CODE_DETAIL FROM tb_code_detail WHERE CODE_GROUP = 'ITEM_TYPE_CODE' AND CODE_DETAIL_NM = #{itemType}) 
		 </if>
		 <if test="excludeSoldOut == null or excludeSoldOut">
		   AND T1.SOLD_OUT_YN = 'N'
		 </if>	
		 ORDER BY	
		 <choose>
		   <when test="sort == '단위가격_오름차순'"> (T1.PRICE * T1.UNIT) ASC, T1.ITEM_NM ASC </when>
		   <when test="sort == '단위가격_내림차순'"> (T1.PRICE * T1.UNIT) DESC, T1.ITEM_NM ASC </when>
		   <when test="sort == '등록일_내림차순'"> T1.FST_REG_DTTI DESC, T1.ITEM_NM ASC </when>
		   <otherwise> T1.ITEM_NM ASC </otherwise>
		 </choose>		 
		 <if test="limit != null">
		 LIMIT #{limit} 
		 </if>		 	 
		 <if test="limit != null and offset != null">
		OFFSET #{offset} 
		 </if>	
	</select>
	
	<!-- 상품 설명을 기반으로 문의와 연관된 상품 목록 조회 -->
	<select id="aiGetDetailItemList" parameterType="map" resultType="map">
		SELECT T1.ITEM_SEQ                                                       AS "상품일련번호"
			 , T1.ITEM_NM                                                        AS "상품명"
			 , T1.PRICE                                                          AS "낱개가격"
			 , T1.UNIT                                                           AS "가격"
			 , T1.PRICE * T1.UNIT 												 AS "단위가격"
			 , (SELECT CODE_DETAIL_NM FROM tb_code_detail WHERE CODE_GROUP = 'ITEM_TYPE_CODE' AND CODE_DETAIL = T1.ITEM_TYPE_CODE)	AS "상품분류"
			 , (SELECT CODE_DETAIL_NM FROM tb_code_detail WHERE CODE_GROUP = 'ITEM_DTL_TYPE_CODE' AND CODE_DETAIL = T1.ITEM_DTL_TYPE_CODE) AS "상품상세분류"
			 , T1.SOLD_OUT_YN                                                    AS "품절여부"
			 , ROUND(IFNULL(O.SALE_CNT, 0) / T1.UNIT)							 AS "판매량"
			 , T1.FST_REG_DTTI                                                   AS "등록일"
			 , T1.RMRK															 AS "상품상세정보"
		  FROM tb_item T1					       								 /*테이블_상품 정보 관리*/
		  LEFT JOIN (
			      SELECT ITEM_SEQ
			           , SUM(CNT) AS SALE_CNT
			        FROM tb_order
			       WHERE ORDER_STATUS_CODE = '11'
			       GROUP BY ITEM_SEQ) O
		    ON T1.ITEM_SEQ = O.ITEM_SEQ	
	  	 WHERE T1.ITEM_SEQ IN
	     <foreach collection="itemSeqList" item="id" open="(" separator="," close=")">
	       #{id}
	     </foreach>
	       AND T1.USE_YN = 'Y'
	       AND T1.SOLD_OUT_YN = 'N'
	     ORDER BY FIELD(T1.ITEM_SEQ,
	     <foreach collection="itemSeqList" item="id" separator=",">
	       #{id}
	     </foreach>
	     )
	</select>	

    <!-- SESSION -->
    <insert id="insertAiSession" parameterType="map"
            useGeneratedKeys="true" keyProperty="sessionId">
      INSERT INTO tb_ai_session
      (USER_SEQ, TITLE, LLM_MODEL, FST_REG_SEQ, LST_UPD_SEQ)
      VALUES
      (#{loginUserSeq}, #{title}, #{llmModel}, #{loginUserSeq}, #{loginUserSeq})
    </insert>
    
    <select id="existsAiSession" parameterType="map" resultType="int">
      SELECT COUNT(1) FROM tb_ai_session WHERE SESSION_ID = #{sessionId}
    </select>
    
    <update id="touchAiSession" parameterType="map">
      UPDATE tb_ai_session
      SET LST_UPD_SEQ = #{lstUpdSeq}, LST_UPD_DTTI = NOW()
      WHERE SESSION_ID = #{sessionId}
    </update>
    
    <!-- TURN -->
    <select id="selectMaxTurnNo" parameterType="map" resultType="int">
      SELECT MAX(TURN_NO) FROM tb_ai_turn WHERE SESSION_ID = #{sessionId}
    </select>
    
    <insert id="insertAiTurn" parameterType="map"
            useGeneratedKeys="true" keyProperty="turnId">
      INSERT INTO tb_ai_turn
      (SESSION_ID, TURN_NO, USER_INPUT, FST_REG_SEQ, LST_UPD_SEQ)
      VALUES
      (#{sessionId}, #{turnNo}, #{userInput}, #{loginUserSeq}, #{loginUserSeq})
    </insert>
    
    <update id="updateAiTurnFinish" parameterType="map">
      UPDATE tb_ai_turn
      SET FINAL_ANSWER = #{finalAnswer},
          ROUND_COUNT = #{roundCount},
          AI_FINISH_RSCD = #{aiFinishRscd},
          ERROR_CODE = #{errorCode},
          ERROR_MESSAGE = #{errorMessage},
          LST_UPD_SEQ = #{loginUserSeq},
          LST_UPD_DTTI = NOW()
      WHERE TURN_ID = #{turnId}
    </update>
    
    <!-- TOOL CALL -->
    <insert id="insertAiToolCall" parameterType="map"
            useGeneratedKeys="true" keyProperty="toolCallId">
      INSERT INTO tb_ai_tool_call
      (TURN_ID, ROUND_NO, CALL_ID, TOOL_NM, ARGUMENTS_JSON,
       FST_REG_SEQ, LST_UPD_SEQ)
      VALUES
      (#{turnId}, #{roundNo}, #{callId}, #{toolNm}, #{argumentsJson},
       #{loginUserSeq}, #{loginUserSeq})
    </insert>
    
    <update id="updateAiToolCallTiming" parameterType="map">
      UPDATE tb_ai_tool_call
      SET START_DTTI = #{startDtti},
          END_DTTI = #{endDtti},
          DURATION_MS = #{durationMs},
          LST_UPD_SEQ = #{loginUserSeq},
          LST_UPD_DTTI = NOW()
      WHERE TOOL_CALL_ID = #{toolCallId}
    </update>
    
    <!-- TOOL RESULT -->
    <insert id="insertAiToolResult" parameterType="map">
      INSERT INTO tb_ai_tool_result
      (TOOL_CALL_ID, RESULT_JSON, RESULT_ROWS,
       ERROR_YN, ERROR_MESSAGE, FST_REG_SEQ, LST_UPD_SEQ)
      VALUES
      (#{toolCallId}, #{resultJson}, #{resultRows},
       #{errorYn}, #{errorMessage}, #{fstRegSeq}, #{lstUpdSeq})
    </insert>
    
    <!-- EVENT -->
    <insert id="insertAiEvent" parameterType="map">
      INSERT INTO tb_ai_event
      (TURN_ID, SEQ_NO, EVENT_TYPE, ROLE,
       TOOL_NM, CALL_ID, CONTENT_TEXT, CONTENT_JSON,
       FST_REG_SEQ, LST_UPD_SEQ)
      VALUES
      (#{turnId}, #{seqNo}, #{eventType}, #{role},
       #{toolNm}, #{callId}, #{contentText}, #{contentJson},
       #{loginUserSeq}, #{loginUserSeq})
    </insert>
    
    <select id="selectRecentEventsBySession" parameterType="map" resultType="map">
      SELECT
        e.EVENT_TYPE,
        e.ROLE,
        e.CALL_ID,
        e.CONTENT_TEXT,
        e.CONTENT_JSON
      FROM tb_ai_event e
      JOIN tb_ai_turn t ON t.TURN_ID = e.TURN_ID
      WHERE t.SESSION_ID = #{sessionId}
      ORDER BY e.FST_REG_DTTI ASC
      LIMIT #{limit}
    </select>	
    
	<!--토큰 사용량 계산-->
	<update id="addAiTurnUsage" parameterType="map">
	  UPDATE tb_ai_turn
	  SET
	    INPUT_TOKENS  = COALESCE(INPUT_TOKENS, 0)  + COALESCE(#{inputTokens}, 0),
	    OUTPUT_TOKENS = COALESCE(OUTPUT_TOKENS, 0) + COALESCE(#{outputTokens}, 0),
	    TOTAL_TOKENS  = COALESCE(TOTAL_TOKENS, 0)  + COALESCE(#{totalTokens}, 0),
	    LST_UPD_SEQ   = #{loginUserSeq},
	    LST_UPD_DTTI  = NOW()
	  WHERE TURN_ID = #{turnId}
	</update>    
	
	<!--토큰 사용량 초과 여부 확인-->
	<select id="isTokenOver" parameterType="map" resultType="boolean">
	    SELECT CASE WHEN IFNULL(SUM(T1.TOTAL_TOKENS), 0) > (SELECT CREDIT FROM tb_user WHERE USER_SEQ = T1.FST_REG_SEQ) THEN TRUE
	           		ELSE FALSE
	            END
	      FROM tb_ai_turn T1				/*테이블_AI턴*/
	     WHERE T1.FST_REG_SEQ = #{loginUserSeq}
		   AND T1.FST_REG_DTTI <![CDATA[ >= ]]> DATE_FORMAT(NOW(), '%Y-%m-01')
		   AND T1.FST_REG_DTTI <![CDATA[ < ]]>  DATE_ADD(DATE_FORMAT(NOW(), '%Y-%m-01'), INTERVAL 1 MONTH)
	</select>	
</mapper>