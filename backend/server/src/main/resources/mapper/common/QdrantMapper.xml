<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mpx.minipx.mapper.QdrantMapper">

	<!-- 상품 목록 조회(전체 적재용) -->
	<select id="qdrantSelectItem" parameterType="map" resultType="camelCaseMap">
		SELECT T1.ITEM_SEQ                         /*상품일련번호*/
			 , T1.ITEM_NM                          /*상품명*/
			 , T1.PRICE                            /*가격*/
			 , T1.UNIT                             /*판매단위*/
			 , T1.PRICE * T1.UNIT AS UNIT_PRICE    /*단위가격*/
			 , T1.RMRK                             /*비고*/
			 , T1.IMG                              /*이미지*/
			 , T1.ITEM_TYPE_CODE                   /*상품 분류코드*/
			 , (SELECT CODE_DETAIL_NM FROM tb_code_detail WHERE CODE_GROUP = 'ITEM_TYPE_CODE' AND CODE_DETAIL = T1.ITEM_TYPE_CODE) ITEM_TYPE_CODE_NM  /*상품 분류코드명*/
			 , T1.ITEM_DTL_TYPE_CODE               /*상품 상세 분류코드*/
			 , (SELECT CODE_DETAIL_NM FROM tb_code_detail WHERE CODE_GROUP = 'ITEM_DTL_TYPE_CODE' AND CODE_DETAIL = T1.ITEM_DTL_TYPE_CODE) ITEM_DTL_TYPE_CODE_NM  /*상품 상세 분류코드명*/
			 , T1.SOLD_OUT_YN                      /*품절여부*/
			 , T1.USE_YN                           /*사용여부*/
			 , T1.FST_REG_SEQ                      /*최초등록자일련번호*/
			 , T1.FST_REG_DTTI                     /*최초등록일시*/
			 , T1.LST_UPD_SEQ                      /*최종수정자일련번호*/
			 , T1.LST_UPD_DTTI                     /*최종수정일시*/
		  FROM tb_item T1					       /*테이블_상품 정보 관리*/
		 WHERE T1.USE_YN = 'Y'
		 <if test='itemSeq != null and itemSeq != ""'>
		   AND T1.ITEM_SEQ = #{itemSeq}
		 </if>		 
	</select>	
	
	<!-- 조건에 부합하는 상품 조회 -->
	<select id="selectRecommendCandidates" parameterType="map" resultType="map">
	  SELECT
	    ITEM_SEQ         	AS itemSeq,
	    ITEM_NM          	AS itemNm,
	    RMRK             	AS rmrk,
	    ITEM_TYPE_CODE   	AS itemTypeCode,
	    ITEM_DTL_TYPE_CODE 	AS itemDtlTypeCode,
	    SOLD_OUT_YN      	AS soldOutYn,
	    USE_YN           	AS useYn
	  FROM tb_item
	  WHERE ITEM_SEQ IN
	  <foreach collection="itemSeqList" item="id" open="(" separator="," close=")">
	    #{id}
	  </foreach>
	    AND USE_YN = 'Y'
	    AND SOLD_OUT_YN = 'N'
	  ORDER BY FIELD(ITEM_SEQ,
	  <foreach collection="itemSeqList" item="id" separator=",">
	    #{id}
	  </foreach>
	  )
	</select>
	
	<!-- 해시 저장 upsert -->
	<insert id="upsertEmbeddingMeta" parameterType="map">
	  INSERT INTO tb_item_ai_embedding (ITEM_SEQ, TEXT_HASH, EMBEDDING_MODEL, VECTOR_SIZE, EMBEDDED_AT)
	  VALUES (#{itemSeq}, #{textHash}, #{embeddingModel}, #{vectorSize}, NOW())
	  ON DUPLICATE KEY UPDATE
	    TEXT_HASH = VALUES(TEXT_HASH),
	    EMBEDDING_MODEL = VALUES(EMBEDDING_MODEL),
	    VECTOR_SIZE = VALUES(VECTOR_SIZE),
	    EMBEDDED_AT = NOW()
	</insert>
	
</mapper>